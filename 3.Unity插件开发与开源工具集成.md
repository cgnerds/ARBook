# Unity插件开发与开源工具集成

## Unity插件开发

**插件**是用不同编程语言撰写的存储代码的dll文件，它是某些需要执行事件的基本实现，或是同一语言中以库或固定事件形式存在的函数核心代码的基本实现。本节将使用C#、C++、Swift、Objective-C和Java创建基本的插件。每个项目都是带有返回值的基本运算函数的实现。对于每种原生语言代码片段来说，使用其编写的插件不超过10分钟就可以完成。完成后，需要在Unity中进行测试。

对于AR应用和游戏来说，会受到一些前置条件的约束，这里也一样。如果使用Apple Mac系列计算机，有如下要求：

- macOS 10.14
- Xcode 10.0
- Unity 2018 for Mac

如果使用的是Windows计算机，有如下要求：

- Windows 10
- Visual Studio 2017
- Unity 2018 for Windows

### C#语言插件

首先，我们使用C#来创建我们的第一个插件：

1. 打开Visual Studio并创建新项目。项目类型为Visual C#→Windows Desktop→Class Library (.NET Framework)。项目名称改为CSharpManagedPlugin, Framework版本为**3.5**，点击OK按钮。

   ![C#Plugin-NewProject](imgs/C#Plugin-NewProject.png)

2. 创建工程后，将类的名称由Class1改为Addition。添加函数Addify，其包含参数a和b，返回a与b之和。如下所示：

   ```c#
   namespace CSharpManagedPlugin
   {
       public class Addition
       {
           public int Addify(int a, int b)
           {
               return a + b;
           }
       }
   }
   ```

3. 打开Unity，创建项目，名称为AREngine，类型为3D。在Asset下创建文件夹AREngine，并创建七个子文件夹，分别为Materials、Models、Plugins、PluginWrappers、Prefabs、Scenes和Scripts。将生成的CSharpManagedPlugin放入Plugins文件夹，如下所示：

   ![1536905169938](imgs/1536905169938.png)

4. 如果设定的.NET版本小于或等于Unity版本，将不会收到错误信息，而且可以在编辑器、独立程序、WebGL、Linux、Windows和macOS上使用。

5. 点击PluginWrappers文件夹，创建脚本并命名为CSharpWrapper，双击打开Visual Studio进行编辑。托管插件是最简单的，我们仅需像调用非MonoBehavior脚本一样，直接调用插件函数即可，代码如下所示：

   ```c#
   using UnityEngine;
   
   public class CSharpWrapper : MonoBehaviour
   {
       // Use this for initialization
       void Start()
       {
           var addition = new CSharpManagedPlugin.Addition();
           var add = addition.Addify(5, 2);
           Debug.Log(add);
       }
   }
   ```

6. 在Unity的Hierarchy窗口，点击右键，选择Create Empty，创建一个空物体GameObject。选中该物体，在Inspector窗口，点击Add Component按钮，输入CSharpWrapper，即可将CSharpWrapper脚本挂载到物体下。点击运行，Console窗口输出如下所示：

   ![C#PluginConsole](imgs/1536906537385.png)

### C++语言插件

这里将再次使用Visual Studio创建C++插件。

1. 打开Visual Studio并创建新项目。项目类型为Visual C++→Windows Desktop→Dynamic-Link Library (DLL)。项目名称改为NativeWindowsPlugin，点击OK按钮。

   ![CPlusPlugin-NewProject](imgs/CPlusPlugin-NewProject.png)

2. 头文件名为NativeWindowsPlugin.h，代码如下：

   ```c++
   #pragma once
   extern "C" {
   #if (defined(WIN32) || defined(__WIN32__))
   	__declspec(dllexport) int Addify(int a, int b);
   #else
   	int Addify(int a, int b);
   #endif
   }
   ```

3. 源文件名为NativeWindowsPlugin.cpp，代码如下：

   ```c++
   #include "stdafx.h"
   #include "NativeWindowsPlugin.h"
   
   int Addify(int a, int b)
   {
   	return a + b;
   }
   ```

4. Solution Configurations设置为**Release**，Solution Platforms设置为**x64**，之后在Solution Explorer选中工程NavitveWindowsPlugin，右击**Build**按钮，即可生成相应的dll文件，位置在x64/Release。

   ![SolutionSetting](/imgs/1537186234603.png)

5. 将上步生成的dll文件拖放到Unity工程中的Plugins文件夹。点击PluginWrappers文件夹，创建脚本并命名为NativeWindowsWrapper，双击打开Visual Studio进行编辑，代码如下所示：

   ```c#
   using System.Runtime.InteropServices;
   using UnityEngine;
   
   public class NativeWindowsWrapper : MonoBehaviour {
   	[DllImport("NativeWindowsPlugin")]
   	public static extern int Addify(int a, int b);
   	
   	private void Start() {
   		var add = Addify(2, 4);
   		Debug.Log(add);
   	}
   }
   
   ```

6. 在Unity的Hierarchy窗口，点击右键，选择Create Empty，创建一个空物体GameObject。选中该物体，在Inspector窗口，点击Add Component按钮，输入NativeWindowsWrapper，即可将NativeWindowsWrapper脚本挂载到物体下。点击运行，Console窗口输出如下所示：

   ![1537186451266](imgs/1537186451266.png)

### Objective-C语言插件

Objective-C是Apple版本的C语言，已经存在了很长时间。虽然Swift被设计用来取代Objective-C，但是Apple并没有将Objective-C降级，直到现在仍然是一个编程利器。

1. 打开Xcode，选择**Create a new Xcode project**，标签页选择**macOS**，页面下方选择**Library**，

### Java语言插件





## 开源工具集成

### OpenCV集成

#### 下载OpenCV

#### 下载CMake





